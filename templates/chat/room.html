{% extends "base.html" %}
{% load staticfiles %}
{% block body %}
    <h1>{{ room.label }}</h1>
    <form id="chatform">
        <table id="chat">
            <tbody>
            {% for message in messages %}
                <tr>
                    <td>{{ message.formatted_timestamp }}</td>
                    <td>{{ message.handle }}</td>
                    <td>{{ message.message }}</td>
                </tr>
            {% endfor %}
            </tbody>
            <tfoot>
            <tr>
                <td>Say something:</td>
                <td colspan=2>
                    <input id="message" type="text" placeholder="message">
                    <button type="submit" id="go">Say it</button>
                </td>
            </tfoot>
        </table>
    </form>
{% endblock %}

{% block js_scripts %}
    <script type="application/javascript" src='{% static "js/reconnecting-websocket.min.js" %}'></script>
    <script type="application/javascript">
        $(function () {
            // When we're using HTTPS, use WSS too.
            var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
            var chatsock = new ReconnectingWebSocket(ws_scheme + '://' + window.location.host + window.location.pathname);

            chatsock.onmessage = function (message) {
                var data = JSON.parse(message.data);
                var chat = $("#chat")
                var ele = $('<tr></tr>')

                ele.append(
                        $("<td></td>").text(data.timestamp)
                );
                ele.append(
                        $("<td></td>").text(data.handle)
                );
                ele.append(
                        $("<td></td>").text(data.message)
                );

                chat.append(ele);
            };

            $("#chatform").on("submit", function (event) {
                var message = {
                    handle: $('#handle').val(),
                    message: $('#message').val()
                };
                chatsock.send(JSON.stringify(message));
                $("#message").val('').focus();
                return false;
            });
        });
    </script>
{% endblock js_scripts %}